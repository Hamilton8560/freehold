name: Release

on:
  push:
    branches: [main]

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  release:
    name: Build & Publish
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          registry-url: https://registry.npmjs.org

      - run: pnpm install --frozen-lockfile

      - run: pnpm build

      - name: Bump versions
        run: |
          node << 'SCRIPT'
          const { execSync } = require("child_process");
          const fs = require("fs");
          const path = require("path");

          const dirs = fs.readdirSync("packages", { withFileTypes: true })
            .filter(d => d.isDirectory())
            .map(d => d.name);

          for (const dir of dirs) {
            const pkgPath = path.join("packages", dir, "package.json");
            const pkg = JSON.parse(fs.readFileSync(pkgPath, "utf8"));

            let latest = "0.0.0";
            try {
              latest = execSync(`npm view ${pkg.name} version`, {
                encoding: "utf8",
                stdio: ["pipe", "pipe", "pipe"],
              }).trim();
            } catch {}

            const [maj, min, pat] = latest.split(".").map(Number);
            pkg.version = `${maj}.${min}.${pat + 1}`;

            fs.writeFileSync(pkgPath, JSON.stringify(pkg, null, 2) + "\n");
            console.log(`${pkg.name}: ${latest} â†’ ${pkg.version}`);
          }
          SCRIPT

      - name: Publish
        run: pnpm -r publish --no-git-checks --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
